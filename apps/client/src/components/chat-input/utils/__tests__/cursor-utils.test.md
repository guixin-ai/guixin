# 光标工具函数测试文档

本文档描述了`cursor-utils.ts`中各个函数的测试用例、测试步骤和预期结果。使用`|`符号表示光标位置，让开发者能够直观地理解各个测试场景。

## 测试环境

测试使用Vitest框架，并创建了一个实际的Lexical编辑器实例，而不是使用模拟数据。测试中使用的节点结构如下：

### 基本结构
```
[零宽空格1][提及节点][零宽空格2]
```

### 混合节点结构
在实际应用中，零宽空格节点可能包含其他字符，形成混合节点：

```
[其他字符零宽空格1][提及节点][零宽空格2其他字符]
```

**重要说明：提及节点和相邻零宽空格之间不可能有其他内容。零宽空格与提及节点直接相连。**

## 测试函数和光标位置

### 1. isCursorBeforeMentionNode

**功能**：检测光标是否位于提及节点前的零宽空格前面

**测试用例1**：光标在纯零宽空格1之前的位置
```
|[零宽空格1][提及节点][零宽空格2]
```

- **测试步骤**：将光标放在段落开头或零宽空格1的前面（offset=0）
- **预期结果**：返回`{position: 'before', mentionNode: 提及节点, zeroWidthSpace: 零宽空格1}`

**测试用例2**：光标在不满足条件的位置
```
[零宽空格1]|[提及节点][零宽空格2]
```

- **测试步骤**：将光标放在其他位置（不在零宽空格1前面）
- **预期结果**：返回`null`

**测试用例3**：光标在混合节点（其他字符+零宽空格）的零宽空格前
```
[其他字符|零宽空格1][提及节点][零宽空格2]
```

- **测试步骤**：将光标放在混合节点中零宽空格的前面
- **预期结果**：返回`{position: 'before', mentionNode: 提及节点, zeroWidthSpace: 混合节点}`

### 2. isCursorAfterMentionNode

**功能**：检测光标是否在提及节点后面的零宽空格之后

**测试用例1**：光标在纯零宽空格2的结尾
```
[零宽空格1][提及节点][零宽空格2]|
```

- **测试步骤**：将光标放在零宽空格2的结尾（offset=1）
- **预期结果**：返回`{position: 'after', mentionNode: 提及节点, zeroWidthSpace: 零宽空格2}`

**测试用例2**：光标在混合节点（零宽空格+其他字符）的零宽空格后
```
[零宽空格1][提及节点][零宽空格|其他字符]
```

- **测试步骤**：将光标放在混合节点中零宽空格的后面
- **预期结果**：返回`{position: 'after', mentionNode: 提及节点, zeroWidthSpace: 混合节点}`

**测试用例3**：光标在混合节点的普通字符后（不应该触发）
```
[零宽空格1][提及节点][零宽空格其他字符|]
```

- **测试步骤**：将光标放在混合节点末尾（普通字符后面）
- **预期结果**：返回`null`（不应触发提及导航逻辑）

### 3. isCursorBeforeMentionGap

**功能**：检测光标是否在零宽空格末尾且与提及节点之间的"夹缝"中

**测试用例1**：光标在纯零宽空格1和提及节点之间
```
[零宽空格1]|[提及节点][零宽空格2]
```

- **测试步骤**：将光标放在零宽空格1的结尾（offset=1）
- **预期结果**：返回`{position: 'beforeMention', mentionNode: 提及节点, zeroWidthSpace: 零宽空格1}`

**测试用例2**：光标在混合节点中零宽空格后和提及节点之间
```
[其他字符零宽空格1]|[提及节点][零宽空格2]
```

- **测试步骤**：将光标放在混合节点末尾（零宽空格后）
- **预期结果**：返回`{position: 'beforeMention', mentionNode: 提及节点, zeroWidthSpace: 混合节点}`

### 4. isCursorAfterMentionGap

**功能**：检测光标是否在提及节点和零宽空格开头之间的"夹缝"中

**测试用例1**：光标在提及节点和纯零宽空格2之间
```
[零宽空格1][提及节点]|[零宽空格2]
```

- **测试步骤**：将光标放在零宽空格2的开头（offset=0）
- **预期结果**：返回`{position: 'afterMention', mentionNode: 提及节点, zeroWidthSpace: 零宽空格2}`

**测试用例2**：光标在提及节点和混合节点中零宽空格之间
```
[零宽空格1][提及节点]|[零宽空格其他字符]
```

- **测试步骤**：将光标放在混合节点开头
- **预期结果**：返回`{position: 'afterMention', mentionNode: 提及节点, zeroWidthSpace: 混合节点}`

### 5. getMentionNodeBeforePosition

**功能**：获取提及节点前的精确位置信息

**测试用例1**：提及节点前有纯零宽空格
```
|[零宽空格1][提及节点][零宽空格2]
```

- **测试步骤**：获取提及节点，调用`getMentionNodeBeforePosition(mention)`
- **预期结果**：返回`{nodeKey: 零宽空格1的键, offset: 0, type: 'text'}`

**测试用例2**：提及节点前有混合节点（其他字符+零宽空格）
```
[其他字符|零宽空格1][提及节点][零宽空格2]
```

- **测试步骤**：获取提及节点，调用`getMentionNodeBeforePosition(mention)`
- **预期结果**：返回`{nodeKey: 混合节点的键, offset: 零宽空格前的位置, type: 'text'}`

**测试用例3**：非提及节点
```
[普通文本]
```

- **测试步骤**：创建普通文本节点，调用`getMentionNodeBeforePosition(textNode)`
- **预期结果**：返回`null`

### 6. getMentionNodeAfterPosition

**功能**：获取提及节点后的精确位置信息

**测试用例1**：提及节点后有纯零宽空格
```
[零宽空格1][提及节点][零宽空格2]|
```

- **测试步骤**：获取提及节点，调用`getMentionNodeAfterPosition(mention)`
- **预期结果**：返回`{nodeKey: 零宽空格2的键, offset: 1, type: 'text'}`

**测试用例2**：提及节点后有混合节点（零宽空格+其他字符）
```
[零宽空格1][提及节点][零宽空格|其他字符]
```

- **测试步骤**：获取提及节点，调用`getMentionNodeAfterPosition(mention)`
- **预期结果**：返回`{nodeKey: 混合节点的键, offset: 零宽空格后的位置, type: 'text'}`

## 光标位置总览

下面是所有测试用例光标位置的合并视图：

### 基本结构
```
// isCursorBeforeMentionNode (用例1)
|[零宽空格1][提及节点][零宽空格2]

// isCursorBeforeMentionNode (用例2)
[零宽空格1]|[提及节点][零宽空格2]

// isCursorAfterMentionNode (用例1)
[零宽空格1][提及节点][零宽空格2]|

// isCursorBeforeMentionGap
[零宽空格1]|[提及节点][零宽空格2]

// isCursorAfterMentionGap
[零宽空格1][提及节点]|[零宽空格2]

// getMentionNodeBeforePosition
|[零宽空格1][提及节点][零宽空格2]

// getMentionNodeAfterPosition
[零宽空格1][提及节点][零宽空格2]|
```

### 混合节点结构
```
// isCursorBeforeMentionNode (用例3)
[其他字符|零宽空格1][提及节点][零宽空格2]

// isCursorAfterMentionNode (用例2)
[零宽空格1][提及节点][零宽空格|其他字符]

// isCursorAfterMentionNode (用例3)
[零宽空格1][提及节点][零宽空格其他字符|]

// isCursorBeforeMentionGap (用例2)
[其他字符零宽空格1]|[提及节点][零宽空格2]

// isCursorAfterMentionGap (用例2)
[零宽空格1][提及节点]|[零宽空格其他字符]

// getMentionNodeBeforePosition (用例2)
|[其他字符零宽空格1][提及节点][零宽空格2]

// getMentionNodeAfterPosition (用例2)
[零宽空格1][提及节点][零宽空格|其他字符]
```

## 节点结构和光标位置图

### 基本结构
```
+-------------------+    +-------------------+    +-------------------+
|                   |    |                   |    |                   |
| [零宽空格1]        |----| [提及节点]        |----| [零宽空格2]        |
|                   |    |                   |    |                   |
+-------------------+    +-------------------+    +-------------------+
↑           ↑                              ↑           ↑           ↑
|           |                              |           |           |
|           |                              |           |           |
|           +------------------------------+           |           |
|          beforeMentionGap                afterMentionGap         |
|                                                                  |
|                                                                  |
+------------------------------------------------------------------+
                          可能的光标位置
```

### 混合节点结构
```
+-------------------------+    +-------------------+    +-------------------------+
|                         |    |                   |    |                         |
| [其他字符零宽空格1]      |----| [提及节点]        |----| [零宽空格2其他字符]      |
|                         |    |                   |    |                         |
+-------------------------+    +-------------------+    +-------------------------+
↑     ↑           ↑                              ↑           ↑     ↑           ↑
|     |           |                              |           |     |           |
|     |           |                              |           |     |           |
|     |           +------------------------------+           |     |           |
|     |         beforeMentionGap                afterMentionGap   |           |
|     |                                                           |           |
|     |                                                           |           |
+-----+-----------------------------------------------------------+-----------+
                                可能的光标位置
```

## 总结

通过这些可视化的测试用例，开发者可以直观地理解`cursor-utils.ts`中各函数的行为和预期结果。这些测试确保了光标相关功能在各种情况下都能正常工作，特别是在处理提及节点周围的零宽空格时。

在编辑器中，提及节点必须与零宽空格直接相邻，之间不能有其他内容。这些测试用例验证了不同光标位置下的行为是否符合预期，确保用户在编辑文本时能够顺畅地与提及节点交互。

### 特别说明

针对混合节点（包含零宽空格和普通字符）的情况，测试用例特别验证了：

1. 光标是否能正确识别零宽空格的位置，不论它在节点中的位置
2. 是否只在光标真正位于零宽空格附近时触发提及导航逻辑
3. 当光标在普通字符上时，是否正确地不触发提及导航逻辑
4. 标准结构始终为：`[其他字符零宽空格1][提及节点][零宽空格2其他字符]`，其中提及节点和相邻零宽空格之间不能有其他内容

这确保了编辑体验的一致性和可预测性，即使在复杂的文本结构中。 