# 提及导航插件 (mention-navigation.plugin.tsx) 分析文档

## 1. 插件功能

提及导航插件(`mention-navigation.plugin.tsx`)是聊天输入组件中的一个核心插件，主要功能包括:

- 处理提及节点周围的光标键盘左右移动
- 确保用户在编辑过程中将提及节点视为一个整体
- 防止光标卡在提及节点的中间状态
- 通过监听左右方向键事件实现光标的精确跳转

## 2. 提及节点导航行为

提及节点的导航行为遵循以下原则:

```mermaid
graph LR
    A["零宽空格前位置"] -->|←左方向键| B["前一位置"]
    A -->|→右方向键| C["零宽空格后位置"]
    C -->|←左方向键| A
    C -->|→右方向键| D["下一位置"]
    E["提及节点"] --- A
    E --- C
```

导航行为说明:

1. **向左导航**: 无论光标在提及节点后方还是后方空隙，都直接跳到提及节点前方
2. **向右导航**: 无论光标在提及节点前方还是前方空隙，都直接跳到提及节点后方
3. **整体性原则**: 提及节点在编辑过程中被视为一个整体，光标不会在提及节点内部停留

需要注意的是：
- **重要**: 插件确保光标总是跳转到提及节点前后的适当位置，而不会在中间状态
- 借助零宽空格字符实现光标的精确定位
- 通过拦截和修改默认的光标移动行为来实现平滑导航体验


## 3. 左右键导航处理流程

插件会截获键盘左右方向键事件，并按以下流程处理:

```mermaid
flowchart TD
    A[监听方向键事件] --> B[获取当前选择和光标位置]
    B --> C[检查选择是否为范围选择且已折叠]
    C -->|否| D[交由默认处理]
    C -->|是| E[分析当前光标位置]
    
    %% 根据方向键分为两个主要分支
    E --> L[左方向键按下]
    E --> R[右方向键按下]
    
    %% 左方向键处理
    L --> F2{isCursorAfterMentionNode\n光标在提及节点后方的\n零宽空格字符后面?}
    L --> F4{isCursorAfterMentionGap\n光标在提及节点与后方\n零宽空格之间的夹缝中?}
    L --> FB{isCursorBeforeMentionGap\n光标在提及节点与前方\n零宽空格之间的夹缝中?}
    
    F2 -->|是| G2[获取提及节点前位置信息]
    F4 -->|是| G2
    FB -->|是| GB[获取零宽空格前最近的\n可设置光标位置]
    
    GB --> GB1{零宽空格前\n是否有字符?}
    GB1 -->|是| GB2[设置光标到\n该字符前]
    GB1 -->|否| GB3[查找前面文本节点\n的末尾位置]
    
    F2 -->|否| D
    F4 -->|否| D
    FB -->|否| D
    
    %% 右方向键处理
    R --> F1{isCursorBeforeMentionNode\n光标在提及节点前方的\n零宽空格字符前面?}
    R --> F3{isCursorBeforeMentionGap\n光标在提及节点与前方\n零宽空格之间的夹缝中?}
    R --> FA{isCursorAfterMentionGap\n光标在提及节点与后方\n零宽空格之间的夹缝中?}
    
    F1 -->|是| G1[获取提及节点后位置信息]
    F3 -->|是| G1
    FA -->|是| GA[获取零宽空格后最近的\n可设置光标位置]
    
    GA --> GA1{零宽空格后\n是否有字符?}
    GA1 -->|是| GA2[设置光标到\n该字符后]
    GA1 -->|否| GA3[查找后面文本节点\n的起始位置]
    
    F1 -->|否| D
    F3 -->|否| D
    FA -->|否| D
    
    %% 共同的后续处理
    G1 --> H[阻止默认行为]
    G2 --> H
    GB2 --> H
    GB3 --> H
    GA2 --> H
    GA3 --> H
    
    H --> I[设置光标到新位置]
    I --> J[处理完成]
```

核心处理逻辑:

1. **左方向键处理**: 
   - 检查光标是否在提及节点后方或后方空隙，如是，获取提及节点前的位置信息
   - 检查光标是否在提及节点前方空隙，如是，获取零宽空格前最近的可设置光标位置：
     - 如果零宽空格前有字符，设置光标到该字符前
     - 如果零宽空格是文本节点中唯一字符，查找前面的文本节点末尾位置
   - 设置光标到确定的位置
   
2. **右方向键处理**: 
   - 检查光标是否在提及节点前方或前方空隙，如是，获取提及节点后的位置信息
   - 检查光标是否在提及节点后方空隙，如是，获取零宽空格后最近的可设置光标位置：
     - 如果零宽空格后有字符，设置光标到该字符后
     - 如果零宽空格是文本节点中唯一字符，查找后面的文本节点起始位置
   - 设置光标到确定的位置

3. **位置获取**:
   - 使用`getMentionNodeBeforePosition`获取提及节点前的位置
   - 使用`getMentionNodeAfterPosition`获取提及节点后的位置
   - 查找零宽空格前后最近的可设置光标位置
     - 检查相邻字符
     - 当需要时，跳过非文本节点找到最近的文本节点的适当位置

4. **光标设置**:
   - 创建新的范围选择
   - 设置选择的锚点和焦点到目标位置
   - 提交选择更新

## 4. 重要注意事项

- 插件依赖于提及节点的标准结构，包括前后零宽空格的存在
- 光标必须能够在提及节点前后定位，这是实现正确导航行为的关键
- 插件通过高优先级(`COMMAND_PRIORITY_HIGH`)拦截方向键事件
- 只有当光标在提及节点周围时才会处理事件，其他情况交由默认处理
- 日志系统用于记录和调试插件行为
- 插件在组件卸载时会清理事件监听器 