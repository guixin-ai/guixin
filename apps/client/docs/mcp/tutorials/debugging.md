# 调试

全面指南，用于调试模型上下文协议（MCP）集成

在开发MCP服务器或将其与应用程序集成时，有效的调试至关重要。本指南涵盖了MCP生态系统中可用的调试工具和方法。

本指南适用于macOS。其他平台的指南即将推出。

## 调试工具概述

MCP提供了几种在不同层次进行调试的工具：

1. **MCP检查器**  
   * 交互式调试界面  
   * 直接服务器测试  
   * 详情请参阅检查器指南
2. **Claude桌面开发者工具**  
   * 集成测试  
   * 日志收集  
   * Chrome DevTools集成
3. **服务器日志**  
   * 自定义日志实现  
   * 错误跟踪  
   * 性能监控

## 在Claude桌面中调试

### 检查服务器状态

Claude.app界面提供基本的服务器状态信息：

1. 点击图标查看：  
   * 已连接的服务器  
   * 可用的提示和资源
2. 点击图标查看：  
   * 向模型提供的工具

### 查看日志

查看Claude桌面的详细MCP日志：

```bash
# 实时跟踪日志
tail -n 20 -F ~/Library/Logs/Claude/mcp*.log
```

日志捕获：

* 服务器连接事件
* 配置问题
* 运行时错误
* 消息交换

### 使用Chrome DevTools

在Claude桌面中访问Chrome的开发者工具来调查客户端错误：

1. 创建一个`developer_settings.json`文件，将`allowDevTools`设置为true：

```bash
echo '{"allowDevTools": true}' > ~/Library/Application\ Support/Claude/developer_settings.json
```

2. 打开DevTools：`Command-Option-Shift-i`

注意：你会看到两个DevTools窗口：

* 主内容窗口
* 应用标题栏窗口

使用Console面板检查客户端错误。

使用Network面板检查：

* 消息负载
* 连接时间

## 常见问题

### 工作目录

在Claude桌面中使用MCP服务器时：

* 通过`claude_desktop_config.json`启动的服务器的工作目录可能是未定义的（如macOS上的`/`），因为Claude桌面可以从任何位置启动
* 始终在配置和`.env`文件中使用绝对路径以确保可靠操作
* 对于通过命令行直接测试服务器，工作目录将是你运行命令的位置

例如在`claude_desktop_config.json`中，使用：

```json
{
  "command": "npx",
  "args": ["-y", "@modelcontextprotocol/server-filesystem", "/Users/username/data"]
}
```

而不是相对路径，如`./data`

### 环境变量

MCP服务器只自动继承一部分环境变量，如`USER`、`HOME`和`PATH`。

要覆盖默认变量或提供自己的变量，可以在`claude_desktop_config.json`中指定`env`键：

```json
{
  "myserver": {
    "command": "mcp-server-myapp",
    "env": {
      "MYAPP_API_KEY": "some_key",
    }
  }
}
```

### 服务器初始化

常见的初始化问题：

1. **路径问题**  
   * 不正确的服务器可执行文件路径  
   * 缺少必需的文件  
   * 权限问题  
   * 尝试为`command`使用绝对路径
2. **配置错误**  
   * 无效的JSON语法  
   * 缺少必需的字段  
   * 类型不匹配
3. **环境问题**  
   * 缺少环境变量  
   * 不正确的变量值  
   * 权限限制

### 连接问题

当服务器无法连接时：

1. 检查Claude桌面日志
2. 验证服务器进程是否正在运行
3. 使用检查器单独测试
4. 验证协议兼容性

## 实现日志记录

### 服务器端日志记录

构建使用本地stdio传输的服务器时，所有记录到stderr（标准错误）的消息都会被主机应用程序（例如，Claude桌面）自动捕获。

本地MCP服务器不应将消息记录到stdout（标准输出），因为这会干扰协议操作。

对于所有传输，你还可以通过发送日志消息通知向客户端提供日志：

```python
server.request_context.session.send_log_message(
  level="info",
  data="服务器成功启动",
)
```

重要的需要记录的事件：

* 初始化步骤
* 资源访问
* 工具执行
* 错误条件
* 性能指标

### 客户端日志记录

在客户端应用程序中：

1. 启用调试日志记录
2. 监控网络流量
3. 跟踪消息交换
4. 记录错误状态

## 调试工作流

### 开发周期

1. 初始开发  
   * 使用检查器进行基本测试  
   * 实现核心功能  
   * 添加日志点
2. 集成测试  
   * 在Claude桌面中测试  
   * 监控日志  
   * 检查错误处理

### 测试更改

要有效测试更改：

* **配置更改**：重启Claude桌面
* **服务器代码更改**：使用Command-R重新加载
* **快速迭代**：在开发期间使用检查器

## 最佳实践

### 日志策略

1. **结构化日志记录**  
   * 使用一致的格式  
   * 包含上下文  
   * 添加时间戳  
   * 跟踪请求ID
2. **错误处理**  
   * 记录堆栈跟踪  
   * 包含错误上下文  
   * 跟踪错误模式  
   * 监控恢复
3. **性能跟踪**  
   * 记录操作时间  
   * 监控资源使用  
   * 跟踪消息大小  
   * 测量延迟

### 安全考虑

调试时：

1. **敏感数据**  
   * 清理日志  
   * 保护凭据  
   * 屏蔽个人信息
2. **访问控制**  
   * 验证权限  
   * 检查身份验证  
   * 监控访问模式

## 获取帮助

遇到问题时：

1. **首要步骤**  
   * 检查服务器日志  
   * 使用检查器测试  
   * 审查配置  
   * 验证环境
2. **支持渠道**  
   * GitHub问题  
   * GitHub讨论
3. **提供信息**  
   * 日志摘录  
   * 配置文件  
   * 重现步骤  
   * 环境详情

## 下一步

了解如何使用MCP检查器

## 用小朋友也能懂的话来说

想象一下，调试就像是成为一名魔法侦探🕵️‍♂️，帮助你的MCP魔法城堡解决各种小问题！

**调试是什么？**就是当你的魔法城堡（MCP服务器）运行得不太顺利时，找出问题所在并修复它的过程。就像医生给生病的病人看病一样！

这里有一些魔法侦探工具可以帮助你：

1. **MCP检查器**：这是一个特殊的放大镜🔍，可以让你仔细观察魔法城堡的每一个细节。

2. **日志书**：城堡会自动记录发生的一切事情在一本特殊的日记本中。当出现问题时，你可以翻开这本日记，看看到底发生了什么！

3. **开发者魔法工具**：这些是更高级的魔法工具，可以深入城堡的内部结构，看到肉眼看不到的魔法流动。

当你的城堡出现问题时，可能是因为：
- 城堡的地图（工作目录）搞混了
- 城堡需要的魔法药水（环境变量）不见了
- 城堡的某些房间（服务器）没有正确连接到大门
- 魔法咒语（代码）中有拼写错误

作为一名优秀的魔法侦探，你需要：
1. 记录下每一条线索（使用好的日志策略）
2. 一步步测试城堡的每个部分
3. 保护城堡中的秘密宝藏（敏感数据）
4. 在需要时寻求其他魔法师的帮助

通过这种方式，无论魔法城堡出现什么问题，你都能像一名出色的魔法侦探一样，找出问题所在，并让城堡恢复正常运行！✨ 